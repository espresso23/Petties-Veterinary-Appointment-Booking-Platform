# ============================================
# PETTIES - Docker Compose for UAT (uat.petties.world)
# Chạy trên EC2, ports khác với production để tránh conflict
# 
# Usage:
#   docker-compose -f docker-compose.uat.yml --env-file .env.uat up -d --build
# 
# Ports:
#   - Backend: 127.0.0.1:8082:8080 (UAT port 8082, production dùng 8080, dev local dùng 8080)
#   - AI Service: 127.0.0.1:8002:8000 (UAT port 8002, production dùng 8000, dev local dùng 8000)
# ============================================

version: '3.8'

services:
  # ============================================
  # SPRING BOOT BACKEND API (UAT)
  # ============================================
  backend-uat:
    build:
      context: ./backend-spring/petties
      dockerfile: Dockerfile
      args:
        BUILD_ENV: prod  # Dùng prod build nhưng với UAT profile
    container_name: petties-uat-backend
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: uat
      # Database - Có thể dùng cùng với production hoặc database riêng
      DB_HOST: ${DB_HOST_UAT:-${DB_HOST}}
      DB_PORT: ${DB_PORT_UAT:-${DB_PORT:-5432}}
      DB_NAME: ${DB_NAME_UAT:-${DB_NAME:-petties_db}}
      DB_USERNAME: ${DB_USERNAME_UAT:-${DB_USERNAME}}
      DB_PASSWORD: ${DB_PASSWORD_UAT:-${DB_PASSWORD}}
      # MongoDB - Có thể dùng cùng hoặc riêng
      MONGO_URI: ${MONGO_URI_UAT:-${MONGO_URI}}
      # AI Service (internal docker network)
      AI_SERVICE_URL: http://ai-service-uat:8000
      # JWT (UAT secret, khác production)
      JWT_SECRET: ${JWT_SECRET_UAT:-UATSecretKeyForUserAcceptanceTesting123456789012345678901234}
      # CORS - Allow UAT domains
      CORS_ORIGINS: ${CORS_ORIGINS_UAT:-https://uat-api.petties.world,https://uat-ai.petties.world,http://localhost:5173,http://localhost:3000}
    ports:
      - "127.0.0.1:8082:8080"  # UAT port 8082 (production dùng 8080, dev local dùng 8080)
    networks:
      - petties-uat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 512M  # UAT có thể dùng ít memory hơn production
        reservations:
          memory: 256M

  # ============================================
  # PYTHON AI AGENT SERVICE (UAT)
  # ============================================
  ai-service-uat:
    build:
      context: ./petties-agent-serivce
      dockerfile: Dockerfile
      args:
        BUILD_ENV: prod  # Dùng prod build nhưng với UAT config
    container_name: petties-uat-ai-service
    restart: unless-stopped
    environment:
      ENVIRONMENT: uat
      APP_DEBUG: "true"  # Enable debug mode for UAT
      # Database
      DATABASE_URL: ${DATABASE_URL_UAT:-${DATABASE_URL}}
      # Qdrant - Có thể dùng cùng hoặc riêng
      QDRANT_URL: ${QDRANT_URL_UAT:-${QDRANT_URL}}
      QDRANT_API_KEY: ${QDRANT_API_KEY_UAT:-${QDRANT_API_KEY}}
      # Ollama
      LLM_PROVIDER: ${LLM_PROVIDER_UAT:-${LLM_PROVIDER:-ollama}}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL_UAT:-${OLLAMA_BASE_URL:-}}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY_UAT:-${OLLAMA_API_KEY:-}}
      OLLAMA_MODEL: ${OLLAMA_MODEL_UAT:-${OLLAMA_MODEL:-kimi-k2:1t-cloud}}
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL_UAT:-${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}}
      # CORS - Allow UAT domains
      CORS_ORIGINS: ${CORS_ORIGINS_UAT:-https://uat-api.petties.world,https://uat-ai.petties.world,http://localhost:5173,http://localhost:3000}
    ports:
      - "127.0.0.1:8002:8000"  # UAT port 8002 (production dùng 8000, dev local dùng 8000)
    networks:
      - petties-uat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M  # UAT có thể dùng ít memory hơn production
        reservations:
          memory: 256M

# ============================================
# NETWORKS
# ============================================
networks:
  petties-uat-network:
    driver: bridge
    name: petties-uat-network

