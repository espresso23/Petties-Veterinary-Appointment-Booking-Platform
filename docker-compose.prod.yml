# ============================================
# PETTIES - Docker Compose for PRODUCTION
# Optimized builds, no hot-reload
#
# Usage:
#   - Local testing: docker-compose -f docker-compose.prod.yml up -d
#   - EC2 deployment: docker-compose -f docker-compose.prod.yml --env-file .env up -d
#   - Ports bind to 127.0.0.1 for Nginx reverse proxy (not exposed publicly)
# ============================================

version: '3.8'

services:
  # ============================================
  # SPRING BOOT BACKEND API (Production)
  # ============================================
  backend:
    build:
      context: ./backend-spring/petties
      dockerfile: Dockerfile
      args:
        BUILD_ENV: prod
    container_name: petties-prod-backend
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
      # Neon PostgreSQL
      DB_HOST: ${DB_HOST:-}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-postgres}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-petties-prod}
      # MongoDB Atlas
      MONGO_URI: ${MONGO_URI:-}
      # AI Service
      AI_SERVICE_URL: http://ai-service:8000
      # JWT (64 chars)
      JWT_SECRET: ${JWT_SECRET:-}
      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-YOUR_WEB_CLIENT_ID.apps.googleusercontent.com}
      # CORS - Production domains only
      CORS_ORIGINS: ${CORS_ORIGINS:-https://petties.world,https://www.petties.world}
      # Email Configuration
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      # Redis (Production - DB 0)
      REDIS_URL: ${REDIS_URL:-}
      REDIS_HOST: ${REDIS_HOST:-}
      REDIS_PORT: ${REDIS_PORT:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_SSL: ${REDIS_SSL:-false}
    ports:
      - "127.0.0.1:8080:8080" # Bind to localhost only (Nginx reverse proxy)
    networks:
      - petties-prod-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/api/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 768M # Optimized for t3.small (2GB RAM)
        reservations:
          memory: 384M

  # ============================================
  # PYTHON AI AGENT SERVICE (Production)
  # ============================================
  ai-service:
    build:
      context: ./petties-agent-serivce
      dockerfile: Dockerfile
      args:
        BUILD_ENV: prod
    container_name: petties-prod-ai-service
    restart: unless-stopped
    environment:
      ENVIRONMENT: production
      APP_DEBUG: "false"
      # Neon PostgreSQL
      DATABASE_URL: ${DATABASE_URL:-}
      # Qdrant Cloud
      QDRANT_URL: ${QDRANT_URL:-o}
      QDRANT_API_KEY: ${QDRANT_API_KEY}
      # Ollama Configuration (Hybrid: Local or Cloud)
      # RECOMMENDED: Use Ollama Cloud (set OLLAMA_API_KEY)
      # - Cloud Mode: Set OLLAMA_API_KEY=sk-... (auto-switches to https://ollama.com)
      # Primary: kimi-k2:1t-cloud (Cloud, 256K context) | kimi-k2 (Local) | Alternatives: llama3, mistral, gemma, qwen2.5:7b
      LLM_PROVIDER: ollama
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY:-} # Required for Cloud mode (recommended)
      OLLAMA_MODEL: ${OLLAMA_MODEL:-kimi-k2:1t-cloud} # Cloud model (256K context window)
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}
      # CORS - Production domains only
      CORS_ORIGINS: ${CORS_ORIGINS:-https://petties.world,https://www.petties.world}
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
    ports:
      - "127.0.0.1:8000:8000" # Bind to localhost only (Nginx reverse proxy)
    networks:
      - petties-prod-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 768M # Optimized for t3.small (2GB RAM)
        reservations:
          memory: 384M

# ============================================
# NETWORKS
# ============================================
networks:
  petties-prod-network:
    driver: bridge
    name: petties-prod-network
