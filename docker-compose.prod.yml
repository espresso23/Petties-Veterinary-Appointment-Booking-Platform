# ============================================
# PETTIES - Docker Compose for PRODUCTION
# Optimized builds, no hot-reload
#
# Usage:
#   - Local testing: docker-compose -f docker-compose.prod.yml up -d
#   - EC2 deployment: docker-compose -f docker-compose.prod.yml --env-file .env up -d
#   - Ports bind to 127.0.0.1 for Nginx reverse proxy (not exposed publicly)
# ============================================

version: '3.8'

services:
  # ============================================
  # SPRING BOOT BACKEND API (Production)
  # ============================================
  backend:
    build:
      context: ./backend-spring/petties
      dockerfile: Dockerfile
      args:
        BUILD_ENV: prod
    container_name: petties-prod-backend
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
      # Neon PostgreSQL
      DB_HOST: ${DB_HOST:-}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-postgres}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-petties-prod}
      # MongoDB Atlas
      MONGO_URI: ${MONGO_URI:-}
      # AI Service
      AI_SERVICE_URL: http://ai-service:8000
      # JWT (64 chars)
      JWT_SECRET: ${JWT_SECRET:-}
      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-YOUR_WEB_CLIENT_ID.apps.googleusercontent.com}
      # Email Configuration
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      # Redis (Production - DB 0)
      REDIS_URL: ${REDIS_URL:-}
      REDIS_HOST: ${REDIS_HOST:-}
      REDIS_PORT: ${REDIS_PORT:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_SSL: ${REDIS_SSL:-false}
      # Cloudinary (Image Upload)
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      #SePay API Token
      SEPAY_API_TOKEN: ${SEPAY_API_TOKEN:-}
      # Sentry Error Monitoring
      SENTRY_DSN: ${SENTRY_BACKEND_DSN:-}
      SENTRY_ENABLED: ${SENTRY_ENABLED:-false}
      # Location Service (Goong.io)
      GOONG_API_KEY: ${GOONG_API_KEY:-}
      # JVM Tuning for limited RAM (v0.1)
      JAVA_OPTS: "-Xmx320m -Xms256m -XX:+UseSerialGC -XX:MaxMetaspaceSize=128m"
    ports:
      - "127.0.0.1:8080:8080" # Bind to localhost only (Nginx reverse proxy)
    networks:
      - petties-prod-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/api/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 512M # Reduced from 768M
        reservations:
          memory: 384M

  # ============================================
  # PYTHON AI AGENT SERVICE (Production)
  # ============================================
  ai-service:
    build:
      context: ./petties-agent-serivce
      dockerfile: Dockerfile
      args:
        BUILD_ENV: prod
    container_name: petties-prod-ai-service
    restart: unless-stopped
    environment:
      ENVIRONMENT: production
      APP_DEBUG: "false"
      # Neon PostgreSQL
      DATABASE_URL: ${DATABASE_URL:-}
      # JWT Secret (Synced with Backend)
      JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY: ${JWT_SECRET}
      # Qdrant Cloud
      QDRANT_URL: ${QDRANT_URL:-}
      QDRANT_API_KEY: ${QDRANT_API_KEY}
      QDRANT_COLLECTION_NAME: petties_knowledge_base
      # AI Architecture: Cloud-Only (OpenRouter + Cohere)
      LLM_PROVIDER: openrouter
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      OPENROUTER_MODEL: ${OPENROUTER_MODEL:-google/gemini-2.0-flash-exp:free}
      # Embeddings
      COHERE_API_KEY: ${COHERE_API_KEY}
      COHERE_EMBEDDING_MODEL: ${COHERE_EMBEDDING_MODEL:-embed-multilingual-v3.0}
      # CORS - Production domains only
      CORS_ORIGINS: ${CORS_ORIGINS:-https://petties.world,https://www.petties.world}
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      # Sentry Error Monitoring
      SENTRY_DSN: ${SENTRY_AI_SERVICE_DSN:-}
    ports:
      - "127.0.0.1:8000:8000" # Bind to localhost only (Nginx reverse proxy)
    networks:
      - petties-prod-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 384M # Reduced from 768M (Cloud-only AI is lightweight)
        reservations:
          memory: 256M

# ============================================
# NETWORKS
# ============================================
networks:
  petties-prod-network:
    driver: bridge
    name: petties-prod-network
