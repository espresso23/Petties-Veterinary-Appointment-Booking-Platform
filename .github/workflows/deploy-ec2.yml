name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs-references/**'
      - 'postman/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2 Production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/petties-backend/Petties-Veterinary-Appointment-Booking-Platform
            
            echo "ğŸš€ ============================================"
            echo "ğŸš€ Deploying PRODUCTION environment..."
            echo "ğŸš€ ============================================"
            
            echo "ğŸ“¥ Fetching latest code from origin..."
            git fetch origin
            
            echo "ğŸ”„ Resetting to origin/main (ensures exact sync)..."
            git checkout main
            git reset --hard origin/main

            mkdir -p backend-spring/petties/src/main/resources/
            cat <<EOF > backend-spring/petties/src/main/resources/firebase-service-account.json
            ${{ secrets.FIREBASE_JSON }}
            EOF
            
            echo "ğŸ“‹ Current commit:"
            git log --oneline -1
            
            echo "ğŸ›‘ Stopping production containers..."
            docker-compose -f docker-compose.prod.yml --env-file .env down
            
            echo "ğŸ”¨ Building and starting production containers..."
            docker-compose -f docker-compose.prod.yml --env-file .env up -d --build
            
            echo "â³ Waiting for services to start..."
            sleep 15
            
            echo "ğŸ¥ Checking backend health (port 8080)..."
            curl -f http://127.0.0.1:8080/api/actuator/health || echo "âš ï¸ Backend health check failed"
            
            echo "ğŸ¤– Checking AI service health (port 8000)..."
            curl -f http://127.0.0.1:8000/health || echo "âš ï¸ AI service health check failed"
            
            echo "ğŸ“œ Showing recent logs..."
            docker-compose -f docker-compose.prod.yml logs --tail=30
            
            echo "ğŸš€ ============================================"
            echo "âœ… Production Deployment complete!"
            echo "ğŸŒ FE: https://www.petties.world"
            echo "ğŸ”Œ BE: https://api.petties.world/api"
            echo "ğŸš€ ============================================"
