# ============================================
# PETTIES - Docker Compose for TEST ENVIRONMENT
# Runs on same EC2 as Production but different ports
# Test BE: 8081, Test AI: 8001
# ============================================

version: '3.8'

services:
  # ============================================
  # SPRING BOOT BACKEND API (Test)
  # ============================================
  backend-test:
    build:
      context: ./backend-spring/petties
      dockerfile: Dockerfile
      args:
        BUILD_ENV: prod # Use prod build (Dockerfile only supports dev/prod)
    container_name: petties-test-backend
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: test
      # Hibernate auto-create schema for test DB
      SPRING_JPA_HIBERNATE_DDL_AUTO: validate
      # Neon PostgreSQL - TEST Branch
      DB_HOST: ${DB_HOST_TEST:-ep-test-branch.neon.tech}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME_TEST:-postgres}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD_TEST}
      # MongoDB - Test database
      MONGO_URI: ${MONGO_URI_TEST:-mongodb+srv://user:pass@cluster/petties_test}
      # AI Service (Test)
      AI_SERVICE_URL: http://ai-service-test:8000
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-YOUR_WEB_CLIENT_ID.apps.googleusercontent.com}
      # Email (shared with prod or test account)
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      # Location Service (Goong.io)
      GOONG_API_KEY: ${GOONG_API_KEY:-}
      # Redis (Staging/Test - DB 1)
      REDIS_URL: ${REDIS_URL:-}
      REDIS_HOST: ${REDIS_HOST:-}
      REDIS_PORT: ${REDIS_PORT:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_SSL: ${REDIS_SSL:-false}
      # JVM Tuning for 384M Container (Test environment)
      JAVA_OPTS: "-Xmx192m -Xms128m -XX:+UseSerialGC -XX:MaxMetaspaceSize=96m"
      SENTRY_DSN: ${SENTRY_BACKEND_DSN:-}
      SENTRY_ENABLED: false
    ports:
      - "127.0.0.1:8081:8080" # Test uses port 8081 externally
    networks:
      - petties-test-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/api/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 384M # Reduced from 512M
        reservations:
          memory: 192M

  # ============================================
  # PYTHON AI AGENT SERVICE (Test)
  # ============================================
  ai-service-test:
    build:
      context: ./petties-agent-serivce
      dockerfile: Dockerfile
      args:
        BUILD_ENV: prod # Use prod build (Dockerfile only supports dev/prod)
    container_name: petties-test-ai-service
    restart: unless-stopped
    environment:
      ENVIRONMENT: test
      APP_DEBUG: "true"
      # Neon PostgreSQL - TEST Branch
      DATABASE_URL: ${DATABASE_URL_TEST:-}
      # Qdrant Cloud (can share with prod or use separate collection)
      QDRANT_URL: ${QDRANT_URL}
      QDRANT_API_KEY: ${QDRANT_API_KEY}
      QDRANT_COLLECTION_NAME: petties_knowledge_base_test
      # JWT Secret (Synced with Backend)
      JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY: ${JWT_SECRET}
      # AI Architecture: Cloud-Only (OpenRouter + Cohere)
      LLM_PROVIDER: openrouter
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      OPENROUTER_MODEL: ${OPENROUTER_MODEL:-google/gemini-2.0-flash-exp:free}
      # Embeddings
      COHERE_API_KEY: ${COHERE_API_KEY}
      COHERE_EMBEDDING_MODEL: ${COHERE_EMBEDDING_MODEL:-embed-multilingual-v3.0}
      # CORS - Test domain only
      CORS_ORIGINS: https://test.petties.world
      # Cloudinary (Image Upload)
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      # Sentry Error Monitoring (disabled for test)
      SENTRY_DSN:
    ports:
      - "127.0.0.1:8001:8000" # Test uses port 8001 externally
    networks:
      - petties-test-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 256M # Minimal for test
        reservations:
          memory: 128M

# ============================================
# NETWORKS (Separate from Production)
# ============================================
networks:
  petties-test-network:
    driver: bridge
    name: petties-test-network
